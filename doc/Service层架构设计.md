# Service层架构设计文档

## 设计概述

Service层采用**"主控Agent + 多功能子Agent"串行链路执行**架构，以主控Agent（Master Agent）作为系统的"大脑"和"指挥官"，统一接收Web层请求，智能决策执行流程，调用专业化功能子Agent（Functional Sub-Agents）完成具体任务，最终整合结果返回给Web层。

### 核心理念
- **主控Agent**: 扮演项目经理或团队大脑的角色，负责理解、规划、协调和监督，本身不执行具体的量化任务
- **功能子Agent**: 各自领域的专家，专注于特定任务的高效执行
- **智能化程度**: 主控Agent的智能化程度决定了整个系统自动化的上限

## 核心设计原则

### 1. 串行链路执行
- 所有Agent按照链路顺序串行执行，不存在并发情况
- HandlerAgent负责决策每一步的执行路径
- 每个子Agent执行完毕后将结果返回给Handler，由Handler决定下一步

### 2. 单一职责
- HandlerAgent：流程控制和决策
- 专业化子Agent：具体领域的分析任务
- 工具系统：提供基础能力支持

### 3. 统一接口
- 所有对外接口统一由Service层提供
- 与Web层和C++引擎层的通信都通过标准化协议

## 架构组件

### 1. 主控Agent (Master Agent) - 系统大脑

**核心职责：**
- **自然语言理解（NLU）**: 精准理解用户以自然语言输入的、可能模糊的策略意图
- **任务规划与拆解（Planning & Decomposition）**: 将宏大的目标分解为一系列逻辑清晰、前后依赖的子任务，并为每个子任务选择最合适的执行Agent
- **工作流编排（Orchestration）**: 管理子任务的执行顺序，确保整个流程顺畅进行
- **状态监控与异常处理（Monitoring & Exception Handling）**: 实时跟踪每个子任务的状态，当出现失败、超时或预期外的结果时，启动容错机制（如重试、切换备用方案）或向用户报警
- **结果汇总与报告生成（Aggregation & Reporting）**: 将各个子Agent返回的结果进行整合，形成一份逻辑连贯、易于理解的最终报告呈现给用户

**智能决策能力：**
- 将模糊的高层次策略想法（如"寻找近期有高管增持的低估值小盘股策略"）拆解成可执行的子任务
- 根据前一步的执行结果动态调整后续执行路径
- 提供策略优化建议和迭代方向（如"策略在某某年份表现不佳，可能需要加入行业中性化约束"）

### 2. 专业化子Agent

#### DataAnalystAgent (数据分析师)
**职责：**
- 股票技术指标分析
- 财务数据分析
- 价格走势分析
- 量价关系分析

**主要工具：**
- 技术指标计算工具
- 财务指标分析工具
- 价格数据处理工具

#### RiskManagerAgent (风控官)
**职责：**
- 投资风险评估
- 仓位管理建议
- 风险指标计算
- 压力测试分析

**主要工具：**
- 风险计算工具
- VaR计算工具
- 相关性分析工具

#### DataCollectionAgent (数据采集与清洗)
**职责：**
- 多源数据获取和整合
- 数据清洗和标准化处理
- 数据质量检查和验证
- 特征工程和因子构建

**主要工具：**
- Tushare数据接口
- 财经新闻爬取工具
- 舆情数据采集工具
- 数据清洗和验证工具

#### StrategyDevelopmentAgent (策略开发与回测)
**职责：**
- 策略代码自动生成
- 回测参数配置和优化
- 历史数据回测执行
- 绩效评估与风险分析

**核心功能：**
- 根据自然语言描述生成交易策略代码
- 设置回测环境（时间范围、基准、交易成本、滑点等）
- 调用C++回测引擎进行高性能历史模拟
- 生成详细的绩效报告（年化收益率、夏普比率、最大回撤、胜率、盈亏比等）
- 规避回测陷阱，确保时点数据的正确性

#### PortfolioManagerAgent (基金经理)
**职责：**
- 投资策略制定
- 资产配置建议
- 交易信号生成
- 业绩归因分析

**主要工具：**
- 策略回测工具
- 组合优化工具
- 信号生成工具

### 3. 工具系统

#### 数据获取工具
- **股价数据工具**: 获取实时和历史价格数据
- **财务数据工具**: 获取上市公司财务报表
- **宏观数据工具**: 获取宏观经济指标

#### 分析计算工具
- **技术指标工具**: 计算各类技术分析指标
- **风险指标工具**: 计算风险相关指标
- **收益指标工具**: 计算投资收益相关指标

#### RAG增强工具
- **向量检索工具**: 从ChromaDB检索相关新闻和研报
- **文本分析工具**: 分析新闻情感和关键信息
- **时序过滤工具**: 确保只检索时间点之前的信息

#### 回测分析工具
- **C++引擎调用工具**: 调用高性能回测引擎
- **策略执行工具**: 执行具体的交易策略
- **性能分析工具**: 分析回测结果和绩效指标

#### 可视化工具
- **图表生成工具**: 生成K线图、收益率曲线等
- **报告生成工具**: 生成投资分析报告
- **数据导出工具**: 导出分析结果

## 执行流程设计

### 基本执行模式
```
Web层请求 → HandlerAgent → 分析意图 → 制定计划
            ↓
子Agent1 ← 决策调用 ← HandlerAgent
            ↓
执行结果 → HandlerAgent → 评估结果 → 决策下一步
            ↓
子Agent2 ← 决策调用 ← HandlerAgent  
            ↓
最终结果 → HandlerAgent → 整合输出 → Web层
```

### 典型用例流程

#### 用例1: "分析茅台的投资价值"
1. **HandlerAgent**: 识别为股票分析请求
2. **调用DataAnalystAgent**: 分析茅台技术指标和财务数据
3. **HandlerAgent**: 评估需要更多信息
4. **调用RAG检索工具**: 获取茅台相关新闻和研报
5. **调用RiskManagerAgent**: 评估投资风险
6. **HandlerAgent**: 整合所有分析结果，给出投资建议

#### 用例2: "设计一个低风险投资策略"
1. **HandlerAgent**: 识别为策略设计请求
2. **调用PortfolioManagerAgent**: 设计基本策略框架
3. **调用RiskManagerAgent**: 评估策略风险水平
4. **调用回测工具**: 验证策略历史表现
5. **调用可视化工具**: 生成策略回测图表
6. **HandlerAgent**: 整合结果，输出完整策略方案

## 接口规范

### Handler与Web层接口
```python
class ServiceHandler:
    def process_request(self, request: UserRequest) -> ServiceResponse:
        """处理Web层请求的统一入口"""
        pass
    
    def get_status(self, task_id: str) -> TaskStatus:
        """获取任务执行状态"""
        pass
```

### Handler与子Agent接口
```python
class BaseAgent:
    def execute(self, task: Task, context: Context) -> AgentResult:
        """执行具体任务"""
        pass
    
    def get_capabilities(self) -> List[str]:
        """返回Agent能力列表"""
        pass
```

### Agent与工具接口
```python
class BaseTool:
    def execute(self, params: Dict) -> ToolResult:
        """执行工具功能"""
        pass
    
    def validate_params(self, params: Dict) -> bool:
        """验证参数有效性"""
        pass
```

## 状态管理

### 执行上下文
- **会话信息**: 用户会话ID、历史对话
- **执行状态**: 当前执行到哪一步、已完成的任务
- **中间结果**: 各Agent的执行结果
- **错误信息**: 执行过程中的异常和警告

### 进度反馈
- **实时状态推送**: 通过WebSocket向前端推送当前执行状态
- **阶段性结果**: 每完成一个重要步骤推送中间结果
- **最终结果**: 所有任务完成后推送完整结果

## 错误处理

### 异常类型
- **数据获取失败**: 外部API调用失败
- **工具执行错误**: 工具内部逻辑错误
- **Agent执行失败**: Agent逻辑处理异常
- **用户输入无效**: 用户请求无法理解或处理

### 容错策略
- **重试机制**: 对临时性错误进行重试
- **降级处理**: 在某些功能不可用时提供简化版本
- **用户反馈**: 及时向用户说明错误情况和建议
- **日志记录**: 详细记录错误信息用于问题排查

## 数据架构设计

### 数据源策略
**启动阶段 - 开源数据优先**
- **Tushare**: A股全市场数据，积分制平滑过渡免费/付费
- **财经媒体爬取**: 东方财富、雪球等平台的舆情数据
- **公开API**: 宏观经济数据、行业数据等

### 数据存储架构
**结构化数据存储**
- **时间序列数据库**: InfluxDB或DolphinDB存储K线数据，针对时间戳索引优化
- **关系型数据库**: MySQL/PostgreSQL存储公司基本信息、财务数据等静态信息

**非结构化数据存储**
- **文档数据库**: MongoDB存储新闻、公告、研报等JSON格式文档
- **向量数据库**: ChromaDB存储新闻和研报的向量化表示，支持语义检索

**RAG增强应用场景**
- **实时新闻分析**: 检索相关政策文件和解读文章
- **合规性检查**: 查询最新交易法规和风控规则
- **历史案例检索**: 寻找相似市场情况的处理经验

### 数据处理流程
1. **数据采集**: 多源数据自动采集和更新
2. **数据清洗**: 异常值处理、缺失值填充
3. **特征工程**: 技术指标计算、因子构建
4. **向量化处理**: 文本数据转换为向量表示
5. **数据验证**: 质量检查和一致性验证

## 技术实现考虑

### 模型选择策略
- **优先选择**: 在中文语料和金融领域充分训练的模型
- **推荐模型**: DeepSeek等国内优秀模型，具备更好的中文理解能力
- **备用方案**: OpenAI GPT-4, Anthropic Claude等国际主流模型

### 框架选择
- **LangGraph**: 作为Agent编排和流程控制框架
- **LangChain**: 提供LLM调用和工具集成能力
- **Pydantic**: 数据验证和序列化
- **AsyncIO**: 异步处理提升响应速度

### 性能优化
- **缓存机制**: 对频繁访问的数据进行缓存
- **连接池**: 数据库和API连接复用
- **资源管控**: 控制并发请求数量和资源使用
- **数据预处理**: 批量处理和预计算常用指标

### 可扩展性
- **插件化设计**: Agent和工具支持动态加载
- **配置驱动**: 通过配置文件控制Agent行为
- **版本管理**: 支持Agent和工具的版本升级
- **微服务架构**: 支持独立部署和横向扩展

### 回测质量保证
- **时点数据正确性**: 严格控制历史回测中的数据泄露问题
- **交易成本模拟**: 包含手续费、印花税、滑点等真实成本
- **市场微结构**: 考虑流动性、冲击成本等市场实际情况

## 完整工作流程示例

### 典型场景: "寻找近期有高管增持的低估值小盘股策略"

**阶段1: 需求定义与任务启动**
1. 用户输入自然语言描述策略想法
2. 主控Agent利用NLU能力理解用户意图
3. 拆解为结构化任务: 数据采集 → 因子筛选 → 策略构建 → 回测验证

**阶段2: 数据准备与特征构建**
4. 主控Agent调用DataCollectionAgent
5. DataCollectionAgent从Tushare获取股票基础数据、高管增持数据、财务指标
6. 执行数据清洗: 处理异常值、填充缺失数据
7. 构建特征: 估值因子(PE、PB)、规模因子(市值)、增持因子(增持比例、频次)

**阶段3: 策略开发与回测**
8. 主控Agent调用StrategyDevelopmentAgent
9. 根据因子组合生成选股策略代码
10. 设置回测参数: 2020-2024年、基准沪深300、考虑交易成本
11. 调用C++回测引擎执行历史模拟
12. 生成绩效报告: 年化收益15.2%、夏普比率1.8、最大回撤8.5%

**阶段4: 风险评估与优化**
13. 主控Agent调用RiskManagerAgent分析回测结果
14. 发现2022年回撤较大，建议加入行业分散约束
15. 主控Agent基于分析结果提出优化建议
16. 可选择开启新一轮优化迭代

**阶段5: 结果展示与交付**
17. 主控Agent整合所有分析结果
18. 生成完整的策略报告: 策略逻辑、历史回测、风险分析、实施建议
19. 调用可视化工具生成图表: 净值曲线、收益分布、因子暴露等
20. 向Web层返回最终结果，用户获得可执行的投资策略

### 系统优势总结
- **自动化程度高**: 从想法到策略的全流程自动化
- **专业化分工**: 每个环节都有专门的Agent负责
- **质量保证**: 严格的回测规范避免数据泄露
- **迭代优化**: 支持基于结果的策略改进循环
- **用户友好**: 自然语言交互，无需编程知识

这个设计既保持了系统的简洁性，又提供了足够的灵活性来处理各种投资分析场景。
